name: test-OpenWrt # å·¥ä½œæµåç§°ï¼šæ„å»º OpenWrt

on:
  workflow_dispatch:
    inputs:
      repo:
        description: 'é€‰æ‹©æºç '
        required: true
        default: 'lede-23.05'
        type: choice
        options:
          - 'lede-23.05'
          - 'immortalwrt-Mt798X'
          - 'immortalwrt'
      branch_lede:
        description: 'åˆ†æ”¯ lede-23.05'
        required: true
        default: 'master'
        type: choice
        options:
          - 'master'
          - 'å…³é—­'  # æ·»åŠ å…³é—­é€‰é¡¹
      branch_immortalwrt-Mt798X:
        description: 'åˆ†æ”¯ immortalwrt-Mt798X'
        required: true
        default: 'master'
        type: choice
        options:
          - 'openwrt-21.02'
          - 'å…³é—­'  # æ·»åŠ å…³é—­é€‰é¡¹
      branch_immortalwrt:
        description: 'åˆ†æ”¯ immortalwrt'
        required: true
        default: 'master'
        type: choice
        options:
          - 'master'
          - 'openwrt-18.06'
          - 'openwrt-18.06-k5.4'
          - 'openwrt-21.02'
          - 'openwrt-23.05'
          - 'å…³é—­'  # æ·»åŠ å…³é—­é€‰é¡¹
      CONFIG_FILE:
        description: 'è¯·é€‰æ‹©é…ç½®æ–‡ä»¶'
        required: true
        default: 'lede.config'
        type: choice
        options:
          - 'lede.config'
          - 'imm.config'
          - 'imm_mt798x.config'
      SSH_ACTION:
        description: 'SSHè¿œç¨‹é…ç½®å›ºä»¶'
        required: false
        default: 'false'
        type: boolean
      UPLOAD_FIRMWARE:
        description: 'ä¸Šä¼ å›ºä»¶åˆ° Github Artifacts'
        required: false
        default: 'true'
        type: boolean
      UPLOAD_RELEASE:
        description: 'å‘å¸ƒå›ºä»¶åˆ° Github Releases'
        required: false
        default: 'false'
        type: boolean
env:
  FEEDS_CONF: feeds.conf.default  # feedsæ–‡ä»¶
  UPLOAD_RELEASE: ${{ github.event.inputs.UPLOAD_RELEASE }}  # æ˜¯å¦ä¸Šä¼ RELEASE
  UPLOAD_FIRMWARE: ${{ github.event.inputs.UPLOAD_FIRMWARE }}  # æ˜¯å¦ä¸Šä¼ FIRMWARE
  UPLOAD_COWTRANSFER: false  # æ˜¯å¦ä¸Šä¼ COWTRANSFER
  UPLOAD_WETRANSFER: false  # æ˜¯å¦ä¸Šä¼ COWTRANSFER
  UPLOAD_BIN_DIR: false  # æ˜¯å¦ä¸Šä¼ Binæ–‡ä»¶
  CACHE_TOOLCHAIN: true
  TZ: Asia/Shanghai # æ—¶åŒºè®¾ç½®
  
  
jobs:
  auto_optional_openwrt:
    runs-on: ubuntu-22.04 # é…ç½®è¿è¡Œç¯å¢ƒä¸º Ubuntu 20.04
    steps:
      - name: æ£€æŸ¥æœåŠ¡å™¨æ€§èƒ½
        run: |
          echo "è­¦å‘Šâš "
          echo "åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½æœ‰é™ï¼Œè‹¥é€‰æ‹©çš„æ’ä»¶è¿‡å¤šï¼ŒåŠ¡å¿…æ³¨æ„CPUæ€§èƒ½ï¼"
          echo -e "å·²çŸ¥CPUå‹å·(é™åº): 7763ï¼Œ8370Cï¼Œ8272CLï¼Œ8171Mï¼ŒE5-2673\n"
          echo "--------------------------CPUä¿¡æ¯--------------------------"
          echo "CPUç‰©ç†æ•°é‡: $(cat /proc/cpuinfo | grep "physical id" | sort | uniq | wc -l)"
          echo "CPUæ ¸å¿ƒæ•°é‡: $(nproc)"
          echo -e "CPUå‹å·ä¿¡æ¯: $(cat /proc/cpuinfo | grep -m1 name | awk -F: '{print $2}')\n"
          echo "--------------------------å†…å­˜ä¿¡æ¯--------------------------"
          echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯:"
          echo -e "$(sudo lshw -short -C memory | grep GiB)\n"
          echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
          echo "ç¡¬ç›˜æ•°é‡: $(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT


      - name: åˆå§‹åŒ–ç¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive # ç¦ç”¨äº¤äº’ï¼Œé»˜è®¤é€‰é¡¹è‡ªåŠ¨é€‰æ‹©ã€‚
        run: |
          # åˆ é™¤æ‰€æœ‰æœ¬åœ° Docker é•œåƒ
          docker rmi $(docker images -q) || true
          # æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶å’Œç›®å½•
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          # æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨
          sudo -E apt-get -qq update
          # å®‰è£… Ubuntu 22.04 çš„ä¾èµ–
          sudo -E apt-get -qq install $(curl -fsSL is.gd/depends_ubuntu_2204)
          # è‡ªåŠ¨æ¸…ç†ä¸å†éœ€è¦çš„è½¯ä»¶åŒ…
          sudo -E apt-get -qq autoremove --purge
          # æ¸…ç†ç¼“å­˜
          sudo -E apt-get -qq clean
          # è®¾ç½®æ—¶åŒº
          sudo timedatectl set-timezone "$TZ"
          # åˆ›å»ºå·¥ä½œç›®å½•å¹¶è®¾ç½®æƒé™
          # sudo mkdir -p /workdir
          # sudo chown $USER:$GROUPS /workdir

      - name: åˆå¹¶ç£ç›˜ç©ºé—´ # è°ƒæ•´ç£ç›˜ç©ºé—´çš„åˆ†é…æ¥ä¼˜åŒ–æ„å»ºç¯å¢ƒ
        uses: easimon/maximize-build-space@master
        with:
          swap-size-mb: 1024
          temp-reserve-mb: 100
          root-reserve-mb: 1024
          
      - name: Cloneå½“å‰ä»“åº“ç”¨äºç¼–è¯‘ # æ£€å‡ºå½“å‰ä»“åº“ä»£ç 
        uses: actions/checkout@v2
        
      - name: å®‰è£…jq # å®‰è£…jq ç”¨äºè¯»å–data.json
        run: sudo apt-get install jq
        
      - name: è¯»å–dataé…ç½®
        id: read_json
        run: |
          echo "REPO_URL=$(jq -r '.REPO_URLS["${{ github.event.inputs.repo }}"]' data.json)" >> $GITHUB_ENV
          echo "CONFIG_FILE=$(jq -r '.CONFIG_FILES["${{ github.event.inputs.repo }}"]' data.json)" >> $GITHUB_ENV
          echo "DIY_P1=$(jq -r '.DIY_SCRIPTS["${{ github.event.inputs.repo }}"].P1' data.json)" >> $GITHUB_ENV
          echo "DIY_P2=$(jq -r '.DIY_SCRIPTS["${{ github.event.inputs.repo }}"].P2' data.json)" >> $GITHUB_ENV
          echo "DIY_P3=$(jq -r '.DIY_SCRIPTS["${{ github.event.inputs.repo }}"].P3 // empty' data.json)" >> $GITHUB_ENV

      - name: æ ¹æ®é€‰æ‹©è®¾ç½®åˆ†æ”¯
        id: set_branch
        run: |
          if [ "${{ github.event.inputs.repo }}" == "lede-23.05" ] && [ "${{ github.event.inputs.branch_lede }}" != "å…³é—­" ]; then
            echo "REPO_BRANCH=${{ github.event.inputs.branch_lede }}" >> $GITHUB_ENV
          elif [ "${{ github.event.inputs.repo }}" == "immortalwrt-Mt798X" ] && [ "${{ github.event.inputs.branch_immortalwrt-Mt798X }}" != "å…³é—­" ]; then
            echo "REPO_BRANCH=${{ github.event.inputs.branch_immortalwrt-Mt798X }}" >> $GITHUB_ENV
          elif [ "${{ github.event.inputs.repo }}" == "immortalwrt" ] && [ "${{ github.event.inputs.branch_immortalwrt }}" != "å…³é—­" ]; then
            echo "REPO_BRANCH=${{ github.event.inputs.branch_immortalwrt }}" >> $GITHUB_ENV
          else
            echo "REPO_BRANCH=" >> $GITHUB_ENV
          fi

      - name: è¾“å‡ºæ‰€æœ‰ç¯å¢ƒå˜é‡å€¼
        run: |
          echo "REPO_URL: $REPO_URL"
          echo "REPO_BRANCH: $REPO_BRANCH"
          echo "FEEDS_CONF: $FEEDS_CONF"
          echo "CONFIG_FILE: $CONFIG_FILE"
          echo "DIY_P1: $DIY_P1"
          echo "DIY_P2: $DIY_P2"
          echo "DIY_P3: $DIY_P3"
          echo "UPLOAD_BIN_DIR: $UPLOAD_BIN_DIR"
          echo "UPLOAD_FIRMWARE: $UPLOAD_FIRMWARE"
          echo "UPLOAD_COWTRANSFER: $UPLOAD_COWTRANSFER"
          echo "UPLOAD_WETRANSFER: $UPLOAD_WETRANSFER"
          echo "UPLOAD_RELEASE: $UPLOAD_RELEASE"
          echo "CACHE_TOOLCHAIN: $CACHE_TOOLCHAIN"
          echo "TZ: $TZ"

      - name: æ‹‰å–æºç  # å…‹éš†é€‰æ‹©æºä»£ç 
        run: |
          df -hT $PWD
          git clone $REPO_URL -b $REPO_BRANCH openwrt
          cd openwrt
          echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV

      - name: æå–é…ç½®ä¿¡æ¯
        run: |
          cp $CONFIG_FILE $OPENWRT_PATH/.config
          cd $OPENWRT_PATH
          make defconfig > /dev/null 2>&1
          SOURCE_REPO="$(echo $REPO_URL | awk -F '/' '{print $(NF)}')"
          echo "SOURCE_REPO=$SOURCE_REPO" >> $GITHUB_ENV
          DEVICE_TARGET=$(cat .config | grep CONFIG_TARGET_BOARD | awk -F '"' '{print $2}')
          echo "DEVICE_TARGET=$DEVICE_TARGET" >> $GITHUB_ENV
          DEVICE_SUBTARGET=$(cat .config | grep CONFIG_TARGET_SUBTARGET | awk -F '"' '{print $2}')
          echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET" >> $GITHUB_ENV
          COMMIT_AUTHOR=$(git show -s --date=short --format="ä½œè€…: %an")
          echo "COMMIT_AUTHOR=$COMMIT_AUTHOR" >> $GITHUB_ENV
          COMMIT_DATE=$(git show -s --date=short --format="æ—¶é—´: %ci")
          echo "COMMIT_DATE=$COMMIT_DATE" >> $GITHUB_ENV
          COMMIT_MESSAGE=$(git show -s --date=short --format="å†…å®¹: %s")
          echo "COMMIT_MESSAGE=$COMMIT_MESSAGE" >> $GITHUB_ENV
          COMMIT_HASH=$(git show -s --date=short --format="hash: %H")
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV

      - name: ç¼“å­˜å·¥å…·é“¾ï¼ŒåŠ é€Ÿç¼–è¯‘ # CACHE_TOOLCHAINç¯å¢ƒå˜é‡æ§åˆ¶
        if: env.CACHE_TOOLCHAIN == 'true'
        uses: HiGarfield/cachewrtbuild@main
        with:
          ccache: false
          mixkey: ${{ env.SOURCE_REPO }}-${{ env.REPO_BRANCH }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}
          prefix: ${{ env.OPENWRT_PATH }}

      - name: åŠ è½½è‡ªå®šä¹‰feeds-P1
        run: |
          [ -e "$FEEDS_CONF" ] && mv "$FEEDS_CONF" openwrt/feeds.conf.default
          chmod +x "$GITHUB_WORKSPACE/$DIY_P1"
          cd openwrt
          "$GITHUB_WORKSPACE/$DIY_P1"


      - name: æ›´æ–°feeds
        run: cd openwrt && ./scripts/feeds update -a

      - name: åˆ¤å®šæ˜¯å¦åŠ è½½DIY_P3_SH
        if: github.event.inputs.repo == 'immortalwrt-Mt798X'
        run: |
          chmod +x $DIY_P3
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P3

      - name: å®‰è£…feeds
        run: cd openwrt && ./scripts/feeds install -a

      - name: åŠ è½½è‡ªå®šä¹‰DIY-P2
        run: |
          [ -e files ] && mv files openwrt/files
          [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
          chmod +x "$GITHUB_WORKSPACE/$DIY_P2"
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P2

      - name: Sè¿æ¥åˆ° Actions çš„ SSH
        uses: P3TERX/ssh2actions@v1.0.0
        if: (github.event.inputs.SSH_ACTION == 'true' && github.event.inputs.SSH_ACTION != 'false') || contains(github.event.action, 'ssh')
        env:
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

      - name: ä¸‹è½½åŒ…
        id: package
        run: |
          cd openwrt
          make defconfig
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: ç¼–è¯‘å›ºä»¶
        id: compile
        run: |
          cd openwrt
          echo -e "$(nproc) thread compile"
          make -j$(nproc) || make -j1 || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT
          grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
          [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

      - name: æ£€æŸ¥ç©ºé—´ä½¿ç”¨æƒ…å†µ
        if: (!cancelled())
        run: df -hT

      - name: ä¸Šä¼  bin ç›®å½•
        uses: actions/upload-artifact@v3
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
        with:
          name: OpenWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: openwrt/bin

      - name: æ•´ç†æ–‡ä»¶
        id: organize
        if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
        run: |
          cd openwrt/bin/targets/*/*
          rm -rf packages
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT
          echo "KERNEL=$(cat *.manifest | grep ^kernel | cut -d- -f2 | tr -d ' ')" >> $GITHUB_ENV
          echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV

      - name: ä¸Šä¼ å›ºä»¶ç›®å½•
        uses: actions/upload-artifact@v3
        if: steps.organize.outputs.status == 'success' && !cancelled()
        with:
          name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE }}

      - name: ä¸Šä¼ å›ºä»¶åˆ° cowtransfer
        id: cowtransfer
        if: steps.organize.outputs.status == 'success' && env.UPLOAD_COWTRANSFER == 'true' && !cancelled()
        run: |
          curl -fsSL git.io/file-transfer | sh
          ./transfer cow --block 2621440 -s -p 64 --no-progress ${FIRMWARE} 2>&1 | tee cowtransfer.log
          echo "::warning file=cowtransfer.com::$(cat cowtransfer.log | grep https)"
          echo "url=$(cat cowtransfer.log | grep https | cut -f3 -d' ')" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ å›ºä»¶åˆ° WeTransfer
        id: wetransfer
        if: steps.organize.outputs.status == 'success' && env.UPLOAD_WETRANSFER == 'true' && !cancelled()
        run: |
          curl -fsSL git.io/file-transfer | sh
          ./transfer wet -s -p 16 --no-progress ${FIRMWARE} 2>&1 | tee wetransfer.log
          echo "::warning file=wetransfer.com::$(cat wetransfer.log | grep https)"
          echo "url=$(cat wetransfer.log | grep https | cut -f3 -d' ')" >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
        id: tag
        if: env.UPLOAD_RELEASE == 'true' && !cancelled()
        run: |
          echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
          touch release.txt
          [ $UPLOAD_COWTRANSFER = true ] && echo "ğŸ”— [Cowtransfer](${{ steps.cowtransfer.outputs.url }})" >> release.txt
          [ $UPLOAD_WETRANSFER = true ] && echo "ğŸ”— [WeTransfer](${{ steps.wetransfer.outputs.url }})" >> release.txt
          echo "status=success" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ å›ºä»¶åˆ°release
        uses: ncipollo/release-action@v1
        if: steps.tag.outputs.status == 'success' && !cancelled()
        with:
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}
          name: ${{ steps.tag.outputs.release_tag }}
          tag: ${{ steps.tag.outputs.release_tag }}
          artifacts: ${{ env.FIRMWARE }}/*
          body: |
            **This is OpenWrt **
            ### ğŸ“’ å›ºä»¶ä¿¡æ¯
            - ğŸ’» å¹³å°æ¶æ„: mediatek-filogic
            - âš½ å›ºä»¶æºç : ${{ env.REPO_URL }}
            - ğŸ’ æºç åˆ†æ”¯: ${{ env.REPO_BRANCH }}
            - ğŸš€ å†…æ ¸ç‰ˆæœ¬: ${{ env.KERNEL }}
            - ğŸŒ é»˜è®¤åœ°å€: 192.168.50.1
            - ğŸ”‘ é»˜è®¤å¯†ç : password
            - ğŸ‘Œ ä½¿ç”¨æ–¹æ³•ï¼šimmortalwrt-21.02æºç åœ¨ubootä¸­é€‰æ‹©immortalwrt-112mé€‰é¡¹åˆ·å…¥squashfs-factoryæ ¼å¼å›ºä»¶ï¼Œå¦‚æœåŸæœ¬ä¸ºimmortalwrt-21.02å›ºä»¶çš„è¯å¯ä¸‹è½½squashfs-sysupgradeåœ¨webé¡µé¢æ›´æ–°å‡çº§ä¸­ä½¿ç”¨ã€‚
            - lede-23.05æºç åœ¨ubootä¸­é€‰æ‹©qwrté€‰é¡¹åˆ·å…¥squashfs-sysupgradeæ ¼å¼å›ºä»¶
            ### ğŸ§Š å›ºä»¶ç‰ˆæœ¬
            - å›ºä»¶ç¼–è¯‘å‰æœ€åä¸€æ¬¡â¦[ä¸»æºç ](${{ env.REPO_URL }})æ›´æ–°è®°å½•
            - ${{ env.COMMIT_AUTHOR }}
            - ${{ env.COMMIT_DATE }}
            - ${{ env.COMMIT_MESSAGE }}
            - ${{ env.COMMIT_HASH }}
